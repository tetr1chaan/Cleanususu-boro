<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clean Burabay</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f5f5f5);
            --tg-text: var(--tg-theme-text-color, #222222);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-link: var(--tg-theme-link-color, #2ea6ff);
            --tg-button: var(--tg-theme-button-color, #2ea6ff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
        }

        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #map { 
            flex: 1; /* –ö–∞—Ä—Ç–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ —Å–≤–µ—Ä—Ö—É */
            width: 100%; 
            z-index: 1;
        }

        .container {
            background: var(--tg-bg);
            padding: 20px;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            position: relative;
            top: -20px;
            z-index: 2;
            box-shadow: 0 -10px 20px rgba(0,0,0,0.05);
            /* –£–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä–æ–º: –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç */
            max-height: 80vh; 
            overflow-y: auto; 
        }

        h3 { margin: 0 0 15px 0; font-size: 18px; font-weight: 700; }

        /* –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å */
        textarea { 
            width: 100%; 
            padding: 12px;
            margin-bottom: 12px; 
            border: 1px solid rgba(0,0,0,0.1); 
            border-radius: 12px; 
            font-size: 16px;
            box-sizing: border-box;
            background: var(--tg-bg);
            color: var(--tg-text);
            outline: none;
            resize: vertical; /* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–∞–º —Ç—è–Ω—É—Ç—å –∑–∞ —É–≥–æ–ª–æ–∫ */
            min-height: 45px;
            font-family: inherit;
        }

        .file-upload {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: var(--tg-secondary-bg);
            border-radius: 12px;
            margin-bottom: 12px;
            color: var(--tg-hint);
            cursor: pointer;
            border: 1px dashed #ccc;
            font-weight: 500;
        }

        /* –û–∫–æ—à–∫–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ */
        #preview-container {
            display: none;
            width: 100%;
            margin-bottom: 15px;
            text-align: center;
        }

        #preview-img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        button { 
            width: 100%; 
            padding: 16px; 
            background-color: var(--tg-button); 
            color: var(--tg-button-text); 
            border: none; 
            border-radius: 14px; 
            font-size: 16px; 
            font-weight: 600; 
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="container">
        <h3>üìç –°–æ–æ–±—â–∏—Ç—å –æ –º—É—Å–æ—Ä–µ</h3>
        
        <textarea id="desc" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é..."></textarea>
        
        <label for="photo" class="file-upload" id="file-label">
            üì∏ <span id="file-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
        </label>
        <input type="file" id="photo" accept="image/*" style="display: none;">

        <div id="preview-container">
            <img id="preview-img" src="" alt="–ü—Ä–µ–≤—å—é">
        </div>

        <button id="submit-btn" onclick="sendReport()">–û–¢–ü–†–ê–í–ò–¢–¨ –ó–ê–Ø–í–ö–£</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        var map = L.map('map', { zoomControl: false }).setView([53.085, 70.28], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var marker;
        var selectedLat, selectedLng;

        map.on('click', function(e) {
            if (marker) map.removeLayer(marker);
            marker = L.marker(e.latlng).addTo(map);
            selectedLat = e.latlng.lat;
            selectedLng = e.latlng.lng;
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        });

        // –õ–û–ì–ò–ö–ê –ü–†–ï–î–ü–†–û–°–ú–û–¢–†–ê –§–û–¢–û
        const photoInput = document.getElementById('photo');
        const previewImg = document.getElementById('preview-img');
        const previewContainer = document.getElementById('preview-container');

        photoInput.onchange = function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'block';
                    document.getElementById('file-text').innerText = "–§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ ‚úÖ";
                }
                reader.readAsDataURL(file);
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            }
        };

        async function sendReport() {
            if (!selectedLat) {
                tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ!");
                return;
            }
            if (!photoInput.files[0]) {
                tg.showAlert("–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ!");
                return;
            }

            let btn = document.getElementById('submit-btn');
            let formData = new FormData();
            formData.append("lat", selectedLat);
            formData.append("lon", selectedLng);
            formData.append("desc", document.getElementById("desc").value);
            formData.append("photo", photoInput.files[0]);

            btn.disabled = true;
            btn.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";

            try {
                let response = await fetch("/submit", { method: "POST", body: formData });
                let result = await response.json();
                tg.showAlert(result.message);
                tg.close();
            } catch (e) {
                tg.showAlert("–û—à–∏–±–∫–∞: " + e);
                btn.disabled = false;
                btn.innerText = "–û–¢–ü–†–ê–í–ò–¢–¨ –ó–ê–Ø–í–ö–£";
            }
        }
    </script>
</body>
</html>